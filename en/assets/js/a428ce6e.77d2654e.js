"use strict";(self.webpackChunkmy_site=self.webpackChunkmy_site||[]).push([[519],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>_});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),u=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},p=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(a),m=i,_=d["".concat(s,".").concat(m)]||d[m]||c[m]||o;return a?n.createElement(_,r(r({ref:t},p),{},{components:a})):n.createElement(_,r({ref:t},p))}));function _(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,r=new Array(o);r[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:i,r[1]=l;for(var u=2;u<o;u++)r[u]=a[u];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},9621:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>c,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var n=a(7462),i=(a(7294),a(3905));const o={jupyter:{jupytext:{text_representation:{extension:".md",format_name:"markdown",format_version:"1.3",jupytext_version:"1.15.1"}},kernelspec:{display_name:"Python 3",name:"python3"}}},r=void 0,l={unversionedId:"2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks/\u8a13\u7df4\u5f8c\u91cf\u5316_TensorFolw_Lite_Quantization_\u9435\u4eba\u8cfd\u793a\u7bc4",id:"2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks/\u8a13\u7df4\u5f8c\u91cf\u5316_TensorFolw_Lite_Quantization_\u9435\u4eba\u8cfd\u793a\u7bc4",title:"\u8a13\u7df4\u5f8c\u91cf\u5316_TensorFolw_Lite_Quantization_\u9435\u4eba\u8cfd\u793a\u7bc4",description:"- \u6b64\u70ba\u9435\u4eba\u8cfd\u7cfb\u5217\u6587\u793a\u7bc4\u6587\u4ef6\uff0c\u53c3\u8003TensorFlow Lite\u5b98\u65b9\u7bc4\u4f8b\u4fee\u6539\u800c\u6210\u3002",source:"@site/docs/2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks/20.\u8a13\u7df4\u5f8c\u91cf\u5316_TensorFolw_Lite_Quantization_\u9435\u4eba\u8cfd\u793a\u7bc4.md",sourceDirName:"2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks",slug:"/2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks/\u8a13\u7df4\u5f8c\u91cf\u5316_TensorFolw_Lite_Quantization_\u9435\u4eba\u8cfd\u793a\u7bc4",permalink:"/my-site/en/docs/2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks/\u8a13\u7df4\u5f8c\u91cf\u5316_TensorFolw_Lite_Quantization_\u9435\u4eba\u8cfd\u793a\u7bc4",draft:!1,editUrl:"https://github.com/willismax/my-site/blob/main/docs/2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks/20.\u8a13\u7df4\u5f8c\u91cf\u5316_TensorFolw_Lite_Quantization_\u9435\u4eba\u8cfd\u793a\u7bc4.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{jupyter:{jupytext:{text_representation:{extension:".md",format_name:"markdown",format_version:"1.3",jupytext_version:"1.15.1"}},kernelspec:{display_name:"Python 3",name:"python3"}}},sidebar:"tutorialSidebar",previous:{title:"Keras_Tuner_\u9435\u4eba\u8cfd\u5206\u4eab",permalink:"/my-site/en/docs/2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks/Keras_Tuner_\u9435\u4eba\u8cfd\u5206\u4eab"},next:{title:"\u6a21\u578b\u512a\u5316_\u526a\u679d_Pruning_",permalink:"/my-site/en/docs/2021ITHome\u9435\u4eba\u8cfd\u300c\u5f9eAI\u843d\u5730\u8ac7MLOps\u300d/\u5be6\u4f5cNotebooks/\u6a21\u578b\u512a\u5316_\u526a\u679d_Pruning_"}},s={},u=[{value:"\u5efa\u7acb\u57fa\u672c\u6a21\u578b",id:"\u5efa\u7acb\u57fa\u672c\u6a21\u578b",level:2},{value:"\u8f49\u70ba TF Lite \u683c\u5f0f",id:"\u8f49\u70ba-tf-lite-\u683c\u5f0f",level:2},{value:"\u8a13\u7df4\u5f8c\u91cf\u5316 Post-Training Quantization",id:"\u8a13\u7df4\u5f8c\u91cf\u5316-post-training-quantization",level:2},{value:"(\u9078\u7528)\u91cf\u5316\u611f\u77e5\u8a13\u7df4 Quantization Aware Training",id:"\u9078\u7528\u91cf\u5316\u611f\u77e5\u8a13\u7df4-quantization-aware-training",level:2}],p={toc:u},d="wrapper";function c(e){let{components:t,...a}=e;return(0,i.kt)(d,(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("a",{href:"https://colab.research.google.com/github/willismax/ML-in-Production-30-days-sharing/blob/main/notebook/20.%E8%A8%93%E7%B7%B4%E5%BE%8C%E9%87%8F%E5%8C%96_TensorFolw_Lite_Quantization_%E9%90%B5%E4%BA%BA%E8%B3%BD%E7%A4%BA%E7%AF%84.ipynb",target:"_parent"},(0,i.kt)("img",{src:"https://colab.research.google.com/assets/colab-badge.svg",alt:"Open In Colab"})),(0,i.kt)("h1",{id:"20tensorfolw-lite-quantization"},"20.TensorFolw Lite Quantization"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u6b64\u70ba\u9435\u4eba\u8cfd\u7cfb\u5217\u6587\u793a\u7bc4\u6587\u4ef6\uff0c\u53c3\u8003",(0,i.kt)("a",{parentName:"li",href:"https://www.tensorflow.org/lite/performance/post_training_quantization"},"TensorFlow Lite\u5b98\u65b9\u7bc4\u4f8b"),"\u4fee\u6539\u800c\u6210\u3002"),(0,i.kt)("li",{parentName:"ul"},"TF Lite \u8a55\u4f30\u51fd\u6578\u53c3\u8003",(0,i.kt)("a",{parentName:"li",href:"https://www.tensorflow.org/lite/performance/post_training_integer_quant_16x8"},"\u4f86\u6e90"),"\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'id="WLBCobD7f1kD"',id:'"WLBCobD7f1kD"'},"# \u5efa\u7acb\u8a55\u4f30\u6a21\u578b\u7684dict\nMODEL_SIZE = {}\nACCURACY = {}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'id="YUXO0Br0ceK5"',id:'"YUXO0Br0ceK5"'},"import tensorflow as tf\nimport numpy as np\nimport os\n")),(0,i.kt)("h2",{id:"\u5efa\u7acb\u57fa\u672c\u6a21\u578b"},"\u5efa\u7acb\u57fa\u672c\u6a21\u578b"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u6a21\u578b\u63a1\u7528",(0,i.kt)("inlineCode",{parentName:"li"},"tf.keras.datasets.mnist"),"\uff0c\u7528CNN\u9032\u884c\u5efa\u6a21\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="6IXwf2IrdYGd" outputId="fe349226-8362-4057-bec2-ff698e560fa8"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"6IXwf2IrdYGd"',outputId:'"fe349226-8362-4057-bec2-ff698e560fa8"'},"# Load MNIST dataset\nmnist = tf.keras.datasets.mnist\n(train_images, train_labels), (test_images, test_labels) = mnist.load_data()\n\n# Normalize the input image so that each pixel value is between 0 to 1.\ntrain_images = train_images / 255.0\ntest_images = test_images / 255.0\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'id="9YdaJpyKeYFG"',id:'"9YdaJpyKeYFG"'},"def model_builder():\n\n  keras = tf.keras\n\n  model = keras.Sequential([\n    keras.layers.InputLayer(input_shape=(28, 28)),\n    keras.layers.Reshape(target_shape=(28, 28, 1)),\n    keras.layers.Conv2D(filters=12, kernel_size=(3, 3), activation='relu'),\n    keras.layers.MaxPooling2D(pool_size=(2, 2)),\n    keras.layers.Flatten(),\n    keras.layers.Dense(10, activation='softmax')\n  ])\n\n  return model\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="nnjoU2Kvd7Qd" outputId="eb1e291f-830c-4e5a-89c2-84504ed87169"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"nnjoU2Kvd7Qd"',outputId:'"eb1e291f-830c-4e5a-89c2-84504ed87169"'},"baseline_model = model_builder()\nbaseline_model.compile(\n    optimizer='adam',\n    loss='sparse_categorical_crossentropy',\n    metrics=['accuracy']\n    )\n\nbaseline_model.summary()\nbaseline_model.save_weights('baseline_weights.h5')\n\nbaseline_model.fit(train_images, train_labels, epochs=1, shuffle=False)\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="s3WnmyYgfnc6" outputId="c157875b-a507-41f2-9099-18ccbb4cc96e"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"s3WnmyYgfnc6"',outputId:'"c157875b-a507-41f2-9099-18ccbb4cc96e"'},"# \u5132\u5b58\u672a\u91cf\u5316\u6a21\u578b\nbaseline_model.save('non_quantized.h5', include_optimizer=False)\n\n# \u8a55\u4f30\u6a21\u578b\u4e26\u7d00\u9304\u6e96\u78ba\u7387\n_, ACCURACY['baseline Keras model'] = baseline_model.evaluate(test_images, test_labels)\n\n# \u7d00\u9304\u6a21\u578b\u5927\u5c0f\nMODEL_SIZE['baseline h5'] = os.path.getsize('non_quantized.h5')\n\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="77vDwp0HBh22" outputId="cef227ac-6a7a-4752-a21f-974e7599f91d"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"77vDwp0HBh22"',outputId:'"cef227ac-6a7a-4752-a21f-974e7599f91d"'},"ACCURACY\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="AnHDBKgUBlRi" outputId="e8afcda2-3c2d-4916-a418-a76ab895bfea"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"AnHDBKgUBlRi"',outputId:'"e8afcda2-3c2d-4916-a418-a76ab895bfea"'},"MODEL_SIZE\n")),(0,i.kt)("h2",{id:"\u8f49\u70ba-tf-lite-\u683c\u5f0f"},"\u8f49\u70ba TF Lite \u683c\u5f0f"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u8f49\u70ba TF Lite \u4f7f\u7528\u7684 ",(0,i.kt)("inlineCode",{parentName:"li"},"*.tflite"),"\u683c\u5f0f\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="QfrTI1liiYgH" outputId="844dc4e7-918d-40e5-e35d-594c172b512c"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"QfrTI1liiYgH"',outputId:'"844dc4e7-918d-40e5-e35d-594c172b512c"'},"converter = tf.lite.TFLiteConverter.from_keras_model(baseline_model)\n\ntflite_model = converter.convert()\n\nwith open('non_quantized.tflite', 'wb') as f:\n    f.write(tflite_model)\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u5efa\u7acbTF Lite \u7684\u8a55\u4f30\u6a21\u578b\u6e96\u78ba\u7387\u7684\u51fd\u6578\uff0c\u8f49\u6a94\u70batflite\u5f8c\u9700\u8981\u7279\u5225\u64b0\u5beb\uff0c\u53c3\u8003",(0,i.kt)("a",{parentName:"li",href:"https://www.tensorflow.org/lite/performance/post_training_integer_quant_16x8#evaluate_the_models"},"\u5b98\u65b9\u7bc4\u4f8b"),"\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'id="QlRgCXsG5iH_"',id:'"QlRgCXsG5iH_"'},'# A helper function to evaluate the TF Lite model using "test" dataset.\n# from: https://www.tensorflow.org/lite/performance/post_training_integer_quant_16x8#evaluate_the_models\ndef evaluate_model(filemane):\n  #Load the model into the interpreters\n  interpreter = tf.lite.Interpreter(model_path=str(filemane))\n  interpreter.allocate_tensors()\n\n  input_index = interpreter.get_input_details()[0]["index"]\n  output_index = interpreter.get_output_details()[0]["index"]\n\n  # Run predictions on every image in the "test" dataset.\n  prediction_digits = []\n  for test_image in test_images:\n    # Pre-processing: add batch dimension and convert to float32 to match with\n    # the model\'s input data format.\n    test_image = np.expand_dims(test_image, axis=0).astype(np.float32)\n    interpreter.set_tensor(input_index, test_image)\n\n    # Run inference.\n    interpreter.invoke()\n\n    # Post-processing: remove batch dimension and find the digit with highest\n    # probability.\n    output = interpreter.tensor(output_index)\n    digit = np.argmax(output()[0])\n    prediction_digits.append(digit)\n\n  # Compare prediction results with ground truth labels to calculate accuracy.\n  accurate_count = 0\n  for index in range(len(prediction_digits)):\n    if prediction_digits[index] == test_labels[index]:\n      accurate_count += 1\n  accuracy = accurate_count * 1.0 / len(prediction_digits)\n\n  return accuracy\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u7cbe\u78ba\u503c\u7565\u6709\u63d0\u5347\uff0c\u6a21\u578b\u5927\u5c0f\u7565\u964d")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="VbkooswO6rgs" outputId="664f2c36-c8d7-4129-9c00-7f280def351b"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"VbkooswO6rgs"',outputId:'"664f2c36-c8d7-4129-9c00-7f280def351b"'},"ACCURACY['non quantized tflite'] = evaluate_model(filemane='non_quantized.tflite')\nACCURACY\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="1-WyYeJrCXYk" outputId="1cb5c140-1cc0-4586-8655-c94f3fd6ebdd"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"1-WyYeJrCXYk"',outputId:'"1cb5c140-1cc0-4586-8655-c94f3fd6ebdd"'},"MODEL_SIZE['non quantized tflite'] = os.path.getsize('non_quantized.tflite')\nMODEL_SIZE\n")),(0,i.kt)("h2",{id:"\u8a13\u7df4\u5f8c\u91cf\u5316-post-training-quantization"},"\u8a13\u7df4\u5f8c\u91cf\u5316 Post-Training Quantization"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u672c\u7bc4\u4f8b\u793a\u7bc4\u8a13\u7df4\u5f8c\u91cf\u5316\u4e4b\u52d5\u614b\u7bc4\u570d\u91cf\u5316 Dynamic range quantization \u3002"),(0,i.kt)("li",{parentName:"ul"},"\u60a8\u4e5f\u53ef\u4ee5\u5617\u8a66\u56fa\u5b9afloat8\u3001float16\u91cf\u5316\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="UBod3nuQjvhA" outputId="74e49926-3563-49e5-f5fe-6a904b7fec89"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"UBod3nuQjvhA"',outputId:'"74e49926-3563-49e5-f5fe-6a904b7fec89"'},"# Dynamic range quantization\nconverter = tf.lite.TFLiteConverter.from_keras_model(baseline_model)\nconverter.optimizations = [tf.lite.Optimize.DEFAULT]\ntflite_model = converter.convert()\n\nwith open('post_training_quantized.tflite', 'wb') as f:\n    f.write(tflite_model)\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u6a21\u578b\u5927\u5c0f\u4e0b\u964d\u8a31\u591a\uff0c\u7cbe\u6e96\u5ea6\u7565\u6709\u63d0\u5347")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="xdKYRUeE9TF3" outputId="3e680646-ac41-487b-8d03-8dad5315d042"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"xdKYRUeE9TF3"',outputId:'"3e680646-ac41-487b-8d03-8dad5315d042"'},"ACCURACY['post training quantized tflite'] = evaluate_model(filemane='post_training_quantized.tflite')\nACCURACY\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="28TGVr0tBePK" outputId="be42848f-8909-464a-e09c-2059660f8d6c"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"28TGVr0tBePK"',outputId:'"be42848f-8909-464a-e09c-2059660f8d6c"'},"MODEL_SIZE['post training quantized tflite'] = os.path.getsize('post_training_quantized.tflite')\nMODEL_SIZE\n")),(0,i.kt)("h2",{id:"\u9078\u7528\u91cf\u5316\u611f\u77e5\u8a13\u7df4-quantization-aware-training"},"(\u9078\u7528)\u91cf\u5316\u611f\u77e5\u8a13\u7df4 Quantization Aware Training"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u7576\u8a13\u7df4\u5f8c\u91cf\u5316\u5c0e\u81f4\u60a8\u7684\u6e96\u78ba\u7387\u4e0b\u964d\u591a\u5230\u7121\u6cd5\u63a5\u53d7\uff0c\u53ef\u4ee5\u8003\u616e\u5728\u91cf\u5316\u6a21\u578b\u4e4b\u524d\u9032\u884c",(0,i.kt)("a",{parentName:"li",href:"https://www.tensorflow.org/model_optimization/guide/quantization/training"},"\u91cf\u5316\u611f\u77e5\u8a13\u7df4 Quantization Aware Training"),"\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u6b64\u65b9\u6cd5\u70ba\u5728\u8a13\u7df4\u671f\u9593\u5728\u6a21\u578b\u4e2d\u63d2\u5165\u5047\u91cf\u5316\u7bc0\u9ede\u4f86\u6a21\u64ec\u7cbe\u5ea6\u640d\u5931\uff0c\u8b93\u6a21\u578b\u5b78\u6703\u9069\u61c9\u7cbe\u5ea6\u640d\u5931\uff0c\u4ee5\u7372\u5f97\u66f4\u6e96\u78ba\u7684\u9810\u6e2c\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u9700\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"tensorflow_model_optimization")," \u6a21\u7d44\uff0c\u8a72\u6a21\u7d44\u63d0\u4f9b ",(0,i.kt)("inlineCode",{parentName:"li"},"quantize_model()")," \u5b8c\u6210\u4efb\u52d9\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u8abf\u6574\u5f8c\u518d\u91cf\u5316\u53ef\u8212\u7de9\u6e96\u78ba\u7387\u4e0b\u964d\u7684\u554f\u984c\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="MBe08Yceqluq" outputId="dc50e8da-b66c-43cc-8213-4ad8df522b56"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"MBe08Yceqluq"',outputId:'"dc50e8da-b66c-43cc-8213-4ad8df522b56"'},"!pip install tensorflow_model_optimization\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u5148\u524d\u521d\u6b65\u8a13\u7df4\u7684 'baseline_weights.h5' \u6a21\u578b\u6b0a\u91cd\u9032\u884c\u512a\u5316\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u6a21\u578b\u589e\u52a0\u4e86\u4e9b\u5047\u7d50\u9ede\u8207 Layer\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="uxFmeLJDqr-C" outputId="3976b8f1-237d-49f8-de61-e4dde087e949"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"uxFmeLJDqr-C"',outputId:'"3976b8f1-237d-49f8-de61-e4dde087e949"'},"import tensorflow_model_optimization as tfmot\n\n# method to quantize a Keras model\nquantize_model = tfmot.quantization.keras.quantize_model\n\n# Define the model architecture.\nmodel_to_quantize = model_builder()\n\n# Reinitialize weights with saved file\nmodel_to_quantize.load_weights('baseline_weights.h5')\n\n# Quantize the model\nq_aware_model = quantize_model(model_to_quantize)\n\n# `quantize_model` requires a recompile.\nq_aware_model.compile(optimizer='adam',\n              loss='sparse_categorical_crossentropy',\n              metrics=['accuracy'])\n\nq_aware_model.summary()\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'id="b1Fk6As8YdOp"',id:'"b1Fk6As8YdOp"'},"q_aware_model.save('quantization_aware_non-quantized.h5', include_optimizer=False)\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u8a13\u7df4\u7d93\u904e\u611f\u77e5\u8a13\u7df4\u7684\u6a21\u578b\uff0c\u60a8\u53ef\u4ee5\u81ea\u884c\u8abf\u6574 epochs\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="yDlzVkgZrCGD" outputId="0b9f9bc3-493b-4c88-b3ad-34ccf086c5a3"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"yDlzVkgZrCGD"',outputId:'"0b9f9bc3-493b-4c88-b3ad-34ccf086c5a3"'},"# Train the model\nq_aware_model.fit(train_images, train_labels, epochs=10, shuffle=False)\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'id="gHtVzNXfrnas"',id:'"gHtVzNXfrnas"'},"_, ACCURACY['quantization aware non-quantized'] = q_aware_model.evaluate(test_images, test_labels, verbose=0)\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="nsEbxnfoBTFx" outputId="b3c42edd-e0f4-43e2-fe52-ce2400020943"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"nsEbxnfoBTFx"',outputId:'"b3c42edd-e0f4-43e2-fe52-ce2400020943"'},"ACCURACY\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'colab={"base_uri": "https://localhost:8080/"} id="NYFr4oUrBTmI" outputId="a64d256e-dc1e-4648-8ca2-1dc6afa42ef9"',colab:'{"base_uri":','"https://localhost:8080/"}':!0,id:'"NYFr4oUrBTmI"',outputId:'"a64d256e-dc1e-4648-8ca2-1dc6afa42ef9"'},"MODEL_SIZE['quantization aware non-quantized'] = os.path.getsize('quantization_aware_non-quantized.h5')\nMODEL_SIZE\n")))}c.isMDXComponent=!0}}]);