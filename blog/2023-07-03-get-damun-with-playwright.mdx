---
slug: 用PlayWright抓取巴哈姆特動漫瘋彈幕分析
title: 用PlayWright抓取巴哈姆特動漫瘋彈幕分析
authors:
  name: Willis Chen
  title: Tech Instructor
  url: https://willismax.github.io/my-site/
GA: G-CH7FZ71WRC
tags: [web,Tech]
---

# 用PlayWright抓取巴哈姆特動漫瘋彈幕分析


在這篇文章中，將探討如何使用Python的PlayWright模組來抓取和分析巴哈姆特動漫瘋的彈幕數據。我們將一步步教你如何安裝PlayWright，如何利用它控制網頁行為，並如何抓取和儲存需要的數據。

什麼是PlayWright?
--------------

[PlayWright](https://github.com/microsoft/playwright-python) 是Microsoft推出的開源專案，是一個Python用戶端，讓我們能夠自動化Web瀏覽器的行為，包括Chrome, Firefox, 和Safari等主流瀏覽器。你可以使用它來進行網站測試、抓取資料，甚至製作自動化的網頁腳本。透過PlayWright，你能控制整個瀏覽過程，包括產生彈幕等動態內容。

如何安裝PlayWright
--------------

安裝PlayWright相當簡單，只需要在你的命令列工具 (例如：終端機或Command Prompt) 輸入以下命令即可：


```
> pip install playwright
``` 

使用PlayWright
------------

首先，我們需要啟動一個PlayWright的實例，並且以我們選定的瀏覽器來執行我們的程式。以下是一個以Chromium瀏覽器為例的程式碼：


```
> python -m playwright codegen -b chromium
```

執行上述命令後，您將開啟一個Chromium瀏覽器並開始與其互動。你的每一個操作，都會自動生成對應的Python程式碼。

codegen命令包含一些可用的參數，例如：

-   `--target`: 設定你的程式語言，如 python、JavaScript等。
-   `-o`: 指定存放生成程式碼的檔案名稱。
-   `-b`: 選擇你想要使用的瀏覽器，如 chromium、firefox或webkit。

以下是一個實際的例子，使用webkit瀏覽器抓取巴哈姆特動漫瘋網站並將程式碼儲存在damun.py文件中：

```
> python -m playwright codegen --target python -o damun.py -b webkit https://ani.gamer.com.tw/
```

## 修改PlayWright腳本
為了包含抓取後的解析及整理，可以在前面透過點選產製的damun.py腳本中，新增解析的程式

```python

from playwright.sync_api import Playwright, sync_playwright
from bs4 import BeautifulSoup
import json
import sys
import time


def run(playwright: Playwright, sn) -> None:
    browser = playwright.chromium.launch(headless=False)
    context = browser.new_context()
    page = context.new_page()

    page.goto(f"https://ani.gamer.com.tw/animeVideo.php?sn={sn}")
    time.sleep(5)

    # screenshot
    page.screenshot(path='ani.jpg', full_page = True)
    
    # use Beautiful to get damun
    soup = BeautifulSoup(page.content(), 'lxml')

    # 列表推導式
    res = [ {
        'userid': li.select_one('.name > span').text.strip(),
        'text' : li.select_one('.sub_content').text.strip(),
        'msg_time' : li.select_one('b').text.strip()
    } for li in soup.select('.sub-list-li')]

    print(res)

    
    # write JSON data to a file
    with open(f'damun_{sn}.json', 'w') as f:
        json.dump(res, f)

    page.close()

    # ---------------------
    context.close()
    browser.close()
    return res


with sync_playwright() as playwright:
    run(playwright, sys.argv[1])
```



執行playwright腳本
--------------

接下來，我們將執行我們生成的腳本，並將結果儲存到變數中。然後，使用Python的ast模組將結果轉換為Python對象。以下是一個實際的例子：
> 33846為動畫的編號，可以更換成想要分析的動畫序號。

```res = ! python damun.py 33846
import ast
res = [ast.literal_eval(i) for i in res]
print(res)
``` 

將[out]內容存至page.json
---------------------

有兩種方式可以將我們獲得的結果儲存為json格式。一種方式是使用linux的命令行將結果重定向到一個json檔案中。例如：

```
python damun.py 33846 > page.json
```

另一種方式是直接在Python腳本中將結果儲存為json檔案。以下是一個實際的例子：

```
import json

file_name = 'damun_33846.json'

with open(file_name, 'r', encoding='utf-8') as f:
    my_data = json.loads(f.read())

    print(my_data) 

    print(type(my_data))
``` 

解析的結果為:
![](https://hackmd.io/_uploads/rkQ5rwxF2.png)


在上述的Python腳本中，首先定義了我們的檔案名稱。然後，我們使用Python的內建函數open讀取該檔案。最後，我們使用json模組的loads函數將讀取到的資料轉換為Python對象。

以上就是如何使用PlayWright抓取並分析巴哈姆特動漫瘋的彈幕數據的全過程。透過這個過程，我們不僅學習到如何使用PlayWright，也學習到如何將抓取到的數據儲存與分析。希望這對你的學習有所幫助。
